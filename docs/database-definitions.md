# Database definitions

Here are most of the database definitions and SQL functions used in the project. Note that all of these tables have row level security enabled in my project.

## Databases

### Users

```sql
create table
  public.users (
    id uuid not null,
    created_at timestamp with time zone null default now(),
    name text null,
    email text null,
    image_url text null,
    register_complete boolean null default false,
    constraint users_pkey primary key (id),
    constraint users_email_key unique (email),
    constraint users_id_fkey foreign key (id) references auth.users (id)
  ) tablespace pg_default;
```

### Rooms

```sql
create table
  public.rooms (
    created_at timestamp with time zone null default now(),
    created_by uuid null,
    name text not null,
    is_private boolean not null default false,
    is_dm boolean not null default false,
    id uuid not null default extensions.uuid_generate_v4 (),
    constraint rooms_pkey primary key (id),
    constraint rooms_id_key unique (id),
    constraint rooms_created_by_fkey foreign key (created_by) references users (id)
  ) tablespace pg_default;

```

### Rooms Passwords

```sql
create table
  public.room_passwords (
    id bigint generated by default as identity not null,
    created_at timestamp with time zone null default now(),
    password text not null,
    created_by uuid not null,
    room_id uuid not null,
    constraint room_passwords_pkey primary key (id),
    constraint room_passwords_created_by_fkey foreign key (created_by) references users (id),
    constraint room_passwords_room_id_fkey foreign key (room_id) references rooms (id) on delete cascade
  ) tablespace pg_default;
```

### Participants

```sql
create table
  public.participants (
    id bigint generated by default as identity not null,
    created_at timestamp with time zone null default now(),
    user_id uuid not null,
    room_id uuid not null,
    last_message_read bigint null,
    constraint participants_pkey primary key (id),
    constraint participants_last_message_read_fkey foreign key (last_message_read) references messages (id) on delete set null,
    constraint participants_room_id_fkey foreign key (room_id) references rooms (id) on delete cascade,
    constraint participants_user_id_fkey foreign key (user_id) references users (id) on delete cascade
  ) tablespace pg_default;
```

### Messages

```sql
create table
  public.messages (
    id bigint generated by default as identity not null,
    created_at timestamp with time zone null default now(),
    user_id uuid not null,
    message_body text not null,
    is_edited boolean not null default false,
    room_id uuid not null,
    updated_at timestamp with time zone null,
    replying_to bigint null,
    replying_to_name text null,
    replying_to_message text null,
    constraint messages_pkey primary key (id),
    constraint messages_replying_to_fkey foreign key (replying_to) references messages (id),
    constraint messages_room_id_fkey foreign key (room_id) references rooms (id) on delete cascade,
    constraint messages_user_id_fkey foreign key (user_id) references users (id) on delete cascade
  ) tablespace pg_default;
```

### Friendships

```sql
create table
  public.friendships (
    created_at timestamp with time zone null default now(),
    user_id_1 uuid null,
    user_id_2 uuid null,
    user_email_1 text null,
    user_email_2 text null,
    status text not null default 'PENDING'::text,
    action_user_id uuid not null,
    room_id uuid null,
    id integer generated by default as identity not null,
    constraint friendships_pkey primary key (id),
    constraint friendships_id_key unique (id),
    constraint friendships_action_user_id_fkey foreign key (action_user_id) references users (id) on delete cascade,
    constraint friendships_room_id_fkey foreign key (room_id) references rooms (id) on delete cascade,
    constraint friendships_user_id_1_fkey foreign key (user_id_1) references users (id),
    constraint friendships_user_id_2_fkey foreign key (user_id_2) references users (id)
  ) tablespace pg_default;

create trigger create_dm_room_trigger
after insert
or
update on friendships for each row
execute function create_dm_room ();

create trigger delete_room_and_participants_on_friendship_delete_trigger
after delete on friendships for each row
execute function delete_room_and_participants_on_friendship_delete ();
```

## Database Functions

### `create_dm_room`

```sql
DECLARE
  new_room_id uuid;
BEGIN
  IF NEW.status = 'FRIENDS' and NEW.room_id IS NULL THEN
    -- Insert data into table_b
    INSERT INTO rooms (created_by, name, is_private, is_dm)
    VALUES (null, 'Direct Message', true, true)
    RETURNING id INTO new_room_id;

    UPDATE friendships
    SET room_id = new_room_id
    WHERE id = NEW.id;

    -- Insert data into table_c
    INSERT INTO participants (user_id, room_id)
    VALUES (NEW.user_id_1, new_room_id);

    INSERT INTO participants (user_id, room_id)
    VALUES (NEW.user_id_2, new_room_id);
  END if;

  RETURN NEW;
END;
```

### `delete_room_and_participants_on_friendship_delete`

```sql
BEGIN
  DELETE FROM rooms
  WHERE id = OLD.room_id;

  RETURN OLD;
END;
```

### `get_message_count`

```sql
DECLARE
  result_record RECORD;
BEGIN
  FOR result_record IN
    SELECT p.room_id, COALESCE(COUNT(m.id), 0) as message_count
    FROM participants p
    LEFT JOIN messages m ON p.room_id = m.room_id AND m.id > p.last_message_read
    WHERE p.user_id = p_user_id
    GROUP BY p.room_id
  LOOP
    room_id := result_record.room_id;
    message_count := result_record.message_count;
    RETURN NEXT;
  END LOOP;
  RETURN;
END;
```

### `is_user_participant_in_room`

```sql
DECLARE
  is_participant BOOLEAN;
BEGIN
  SELECT EXISTS (
    SELECT 1
    FROM participants
    WHERE participants.user_id = p_user_id AND participants.room_id = p_room_id
  ) INTO is_participant;

  RETURN is_participant;
END;
```
